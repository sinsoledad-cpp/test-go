version: '3.8'
services:
  kafka:
    image: bitnami/kafka:3.9.0
    container_name: kafka
    restart: unless-stopped
    ports:
      - "9092:9092"    # 外部客户端 (如您的Go程序) 连接端口
      - "9093:9093"    # 控制器通信端口 (通常无需暴露给主机，但保留亦可)
    environment:
      # KRaft 模式配置
      - KAFKA_ENABLE_KRAFT=yes
      - KAFKA_CFG_PROCESS_ROLES=controller,broker
      - KAFKA_CFG_NODE_ID=1
      # 1.【关键修改】使用服务名'kafka'代替IP地址，这是Docker网络内部的通信方式
      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@kafka:9093

      # 监听器配置
      # 2.【关键修改】定义了三个监听器：
      # EXTERNAL: 用于外部客户端（您的Go程序）连接
      # INTERNAL: 用于内部容器间（Kafka与Kafdrop）通信
      # CONTROLLER: 用于KRaft控制器通信
      - KAFKA_CFG_LISTENERS=EXTERNAL://:9092,INTERNAL://:29092,CONTROLLER://:9093

      # 3.【关键修改】对外公告的地址
      # EXTERNAL 公告为 localhost，供您的主机Go程序使用
      # INTERNAL 公告为 kafka服务名+内部端口，供Kafdrop使用
      - KAFKA_CFG_ADVERTISED_LISTENERS=EXTERNAL://localhost:9092,INTERNAL://kafka:29092

      # 安全协议映射（增加了EXTERNAL）
      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT,EXTERNAL:PLAINTEXT

      # Broker间通信使用内部监听器
      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL
      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
    networks:
      - kafka-net

  kafdrop:
    image: obsidiandynamics/kafdrop:latest
    container_name: kafdrop
    restart: unless-stopped
    ports:
      - "19000:9000"  # 将Kafdrop的UI端口映射到主机的19000端口
    environment:
      # Kafdrop 通过 Kafka 的内部监听器进行连接
      - KAFKA_BROKERCONNECT=kafka:29092
    depends_on:
      - kafka
    networks:
      - kafka-net

# 4.【新增】明确定义一个网络，确保所有服务都在其中
networks:
  kafka-net:
    driver: bridge













###########################################

#  kafka:
#    image: bitnami/kafka:3.9.0  #
#    container_name: kafka
#    restart: unless-stopped  # 除非手动停止，否则容器退出时自动重启
#    environment:
#      - KAFKA_ENABLE_KRAFT=yes
#      # 节点角色：同时作为控制器(controller)和 broker
#      # 在KRaft模式下，节点可以是纯控制器、纯broker或混合角色
#      - KAFKA_CFG_PROCESS_ROLES=controller,broker
#      # 节点ID：在集群中唯一标识当前节点，取值范围1-255
#      - KAFKA_CFG_NODE_ID=1
#      - KAFKA_CFG_CONTROLLER_QUORUM_VOTERS=1@10.62.160.180:9093
#      # 指定控制器使用的监听器名称（需与下方LISTENERS配置对应）
#      - KAFKA_CFG_CONTROLLER_LISTENER_NAMES=CONTROLLER
#      # 指定broker之间通信使用的监听器名称
#      # 必须与ADVERTISED_LISTENERS中定义的监听器名称一致
#      - KAFKA_CFG_INTER_BROKER_LISTENER_NAME=INTERNAL
#      # 配置Kafka监听的网络接口和端口
#      # 格式：监听器名称://绑定地址:端口
#      # INTERNAL: 用于内部通信和客户端连接的监听器，绑定所有网络接口(:9092)
#      # CONTROLLER: 用于控制器之间通信的监听器，绑定所有网络接口(:9093)
#      - KAFKA_CFG_LISTENERS=INTERNAL://:9092,CONTROLLER://:9093
#      # 配置对外公告的监听器地址（客户端实际连接的地址）
#      # 当客户端连接Kafka时，Kafka会返回此地址给客户端
#      # 这里设置为宿主机的IP:端口（需根据实际环境修改10.62.160.180为宿主机IP）
#      - KAFKA_CFG_ADVERTISED_LISTENERS=INTERNAL://10.62.160.180:9092
#      # 配置监听器的安全协议映射
#      # 格式：监听器名称:协议类型
#      # PLAINTEXT表示不加密传输（适用于开发环境）
#      - KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP=CONTROLLER:PLAINTEXT,INTERNAL:PLAINTEXT
#    ports:
#      - "9092:9092"  # 客户端连接端口
#      - "9093:9093"  # 控制器通信端口